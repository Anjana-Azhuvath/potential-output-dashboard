# ===========================================
# dashboard.py â€” Potential Output & Business Cycle Dashboard
# ===========================================
import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from statsmodels.tsa.filters.hp_filter import hpfilter

st.set_page_config(page_title="GDP Potential Output Dashboard", layout="wide")

st.title("ðŸ‡®ðŸ‡³ Potential Output & Business Cycle Dashboard")

st.markdown("""
This dashboard analyzes **Real GDP**, estimates **Potential GDP** using the Hodrickâ€“Prescott (HP) filter,
and visualizes business cycle phases for India.  
Upload your quarterly Real GDP data in CSV format.
""")

# === File Upload ===
uploaded_file = st.file_uploader("ðŸ“ Upload GDP CSV (e.g. RGDP_IND_Q_NSA.csv)", type=["csv"])

if uploaded_file:
    df = pd.read_csv(uploaded_file)

    # --- Detect and rename columns ---
    if "observation_date" in df.columns and "NGDPRNSAXDCINQ" in df.columns:
        df = df.rename(columns={"observation_date": "Date", "NGDPRNSAXDCINQ": "Real_GDP"})
    else:
        date_col = [c for c in df.columns if "date" in c.lower() or "quarter" in c.lower()][0]
        gdp_col = [c for c in df.columns if any(x in c.lower() for x in ["gdp","output","real"])][0]
        df = df.rename(columns={date_col:"Date", gdp_col:"Real_GDP"})

    # --- Data Prep ---
    df["Date"] = pd.to_datetime(df["Date"], errors="coerce")
    df = df.set_index("Date").sort_index()
    df["Real_GDP"] = pd.to_numeric(df["Real_GDP"], errors="coerce")

    # --- HP Filter ---
    cycle, trend = hpfilter(df["Real_GDP"], lamb=1600)
    df["Trend"], df["Cycle"] = trend, cycle
    df["Output_Gap_%"] = (cycle/trend)*100

    # --- Growth Rates ---
    df["QoQ_Growth_%"] = df["Real_GDP"].pct_change()*100
    df["YoY_Growth_%"] = df["Real_GDP"].pct_change(4)*100
    df["Potential_Growth_%"] = df["Trend"].pct_change()*100

    # --- Rolling CAGR ---
    window = 16
    df["Rolling_CAGR_%"] = ((df["Real_GDP"]/df["Real_GDP"].shift(window))**(1/(window/4))-1)*100

    # --- Summary Stats ---
    start, end = df.index.min(), df.index.max()
    yrs = (end-start).days/365.25
    cagr = (df.iloc[-1]["Real_GDP"]/df.iloc[0]["Real_GDP"])**(1/yrs)-1
    avg_gap = df["Output_Gap_%"].mean()
    avg_qoq = df["QoQ_Growth_%"].mean()
    avg_yoy = df["YoY_Growth_%"].mean()
    avg_potential = df["Potential_Growth_%"].mean()
    above_potential = (df["Output_Gap_%"]>0).mean()*100

    # === Tabs ===
    tabs = st.tabs([
        "ðŸ“Š Overview", 
        "ðŸ“ˆ Actual vs Potential GDP",
        "ðŸ“‰ Output Gap",
        "ðŸ“ˆ Growth Rates",
        "ðŸ“Š Rolling CAGR",
        "ðŸ§  Macro Analysis",
        "ðŸ“„ Data"
    ])

    # --- Tab 1: Overview ---
    with tabs[0]:
        st.subheader("ðŸ“Š Summary Statistics")
        col1, col2, col3 = st.columns(3)
        col1.metric("Full-Period CAGR", f"{cagr*100:.2f}%")
        col2.metric("Avg QoQ Growth", f"{avg_qoq:.2f}%")
        col3.metric("Avg YoY Growth", f"{avg_yoy:.2f}%")
        col1.metric("Avg Potential Growth", f"{avg_potential:.2f}%")
        col2.metric("Avg Output Gap", f"{avg_gap:.2f}%")
        col3.metric("Above Potential (Quarters)", f"{above_potential:.1f}%")

        st.markdown(f"**Period:** {start.date()} â†’ {end.date()}")
        st.write("These statistics summarize the long-term and cyclical performance of the economy.")

    # --- Tab 2: Actual vs Potential GDP ---
    with tabs[1]:
        fig1 = go.Figure()
        fig1.add_trace(go.Scatter(x=df.index, y=df["Real_GDP"]/1e7, name="Actual GDP", mode="lines"))
        fig1.add_trace(go.Scatter(x=df.index, y=df["Trend"]/1e7, name="Potential GDP (HP Trend)",
                                  mode="lines", line=dict(dash="dash")))
        fig1.update_layout(title="Actual vs Potential GDP (HP Filter)",
                           yaxis_title="GDP (â‚¹ crore)", template="plotly_white", hovermode="x unified")
        st.plotly_chart(fig1, use_container_width=True)

    # --- Tab 3: Output Gap ---
    with tabs[2]:
        fig2 = go.Figure()
        fig2.add_trace(go.Scatter(x=df.index, y=df["Output_Gap_%"], fill="tozeroy",
                                  fillcolor="rgba(0,200,0,0.2)", line=dict(color="green"), name="Output Gap (%)"))
        fig2.add_trace(go.Scatter(x=df.index, y=[min(y,0) for y in df["Output_Gap_%"]],
                                  fill="tozeroy", fillcolor="rgba(255,0,0,0.2)",
                                  line=dict(color="red", width=0), name="Below Potential"))
        fig2.add_hline(y=0, line_dash="dash", line_color="black")
        fig2.update_layout(title="Output Gap and Business Cycle",
                           yaxis_title="Output Gap (%)", template="plotly_white", hovermode="x unified")
        st.plotly_chart(fig2, use_container_width=True)

    # --- Tab 4: Growth Rates ---
    with tabs[3]:
        fig3 = go.Figure()
        fig3.add_trace(go.Scatter(x=df.index, y=df["QoQ_Growth_%"], name="QoQ Growth", mode="lines"))
        fig3.add_trace(go.Scatter(x=df.index, y=df["YoY_Growth_%"], name="YoY Growth", mode="lines"))
        fig3.add_trace(go.Scatter(x=df.index, y=df["Potential_Growth_%"],
                                  name="Potential Growth", mode="lines", line=dict(dash="dash")))
        fig3.update_layout(title="GDP Growth Rates (QoQ, YoY, Potential)",
                           yaxis_title="Growth Rate (%)", template="plotly_white", hovermode="x unified")
        st.plotly_chart(fig3, use_container_width=True)

    # --- Tab 5: Rolling CAGR ---
    with tabs[4]:
        fig4 = px.line(df, x=df.index, y="Rolling_CAGR_%", title="Rolling 4-Year CAGR of Real GDP (%)")
        fig4.add_hline(y=cagr*100, line_dash="dash", line_color="red",
                       annotation_text=f"Full-period CAGR: {cagr*100:.2f}%")
        fig4.add_trace(go.Scatter(x=df.index, y=df["Potential_Growth_%"],
                                  mode="lines", name="Potential Growth", line=dict(dash="dot", color="green")))
        fig4.update_layout(template="plotly_white", hovermode="x unified")
        st.plotly_chart(fig4, use_container_width=True)

    # --- Tab 6: Macro Analysis ---
    with tabs[5]:
        st.subheader("ðŸ§  Interpretation")
        st.markdown("""
        - **Positive output gap:** economy above potential (expansion phase)  
        - **Negative output gap:** economy below potential (recession phase)  
        - **Potential growth** reflects long-term productive capacity.  
        **Policy hint:** tighten during sustained positive gaps; ease when negative.
        """)

    # --- Tab 7: Data Table ---
    with tabs[6]:
        st.dataframe(df.tail(20))
        csv = df.to_csv().encode("utf-8")
        st.download_button("ðŸ“¥ Download Processed Data (CSV)", csv, "processed_gdp_hpfilter.csv", "text/csv")

else:
    st.info("ðŸ‘† Upload your GDP CSV file to begin analysis.")
